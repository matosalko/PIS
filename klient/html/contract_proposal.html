<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIS projekt</title>
</head>
<body>
    <table id='info_table'>
        <tr id="insured_user_name">
            <td>Meno poistenca:</td>
        </tr>
        <tr id="insurance_number">
            <td>Cislo poistky:</td>
        </tr>
        <tr id="phone">
            <td>Telefonne cislo:</td>
        </tr>
        <tr id="SPZ">
            <td>SPZ vozidla:</td>
        </tr>
    </table>

    <table id='packages_table'>
        <tr>
            <td>Nazov balika</td>
            <td>Cena balika</td>
        </tr>
    </table>

    <script>
        let changed_packages = JSON.parse(localStorage.getItem('changed_insurance_packages'));
        let changed_insuracne = JSON.parse(localStorage.getItem('changed_insurance'));
        let user;
        let insurance;
        let packages = [];
        let vehicle;
        const user_id = localStorage.getItem('user_id');
        const insurance_id = localStorage.getItem('selected_insurance_id');
        let total_price = 0;

        async function get_user() {
            const response = await fetch(`/api/user/${user_id}`);
            const json = await response.json();

            user = json.body;
        }

        async function get_insurance() {
            const response = await fetch(`/api/insurance/${insurance_id}`);
            const json = await response.json();

            insurance = json.body;
        }

        async function get_packages() {
            for(item of changed_packages) {
                const response = await fetch(`/api/package/${item.package_id}`);
                const json = await response.json();
                packages.push(json.body);
            }
        }

        async function get_vehicle() {
            const response = await fetch(`/api/vehicle/${insurance.vehicle_id}`);
            const json = await response.json();

            vehicle = json.body;
        }

        async function create_proposal() {
            await get_user();
            await get_insurance();
            await get_packages();
            await get_vehicle();

            let tbl = document.getElementById("packages_table");
            //pridanie riadkov s balikmi v upravenej zmluve
            for(item of packages) { 
                let tr = document.createElement("tr");
                let td1 = document.createElement("td");
                let td2 = document.createElement("td");
                
                let name = `${item.name}`;
                let price = item.price;
                total_price += price;

                td1.appendChild(document.createTextNode(name));
                td2.appendChild(document.createTextNode(price));
                
                tr.appendChild(td1);
                tr.appendChild(td2);
                tbl.appendChild(tr);
            }
            //-------------------------pridanie riadku so zlavou-----------------------
            tr = document.createElement("tr");
            td1 = document.createElement("td");
            td2 = document.createElement("td");
            
            name = 'zlava';
            let discount = changed_insuracne.discount || 0;
            total_price -= discount;

            td1.appendChild(document.createTextNode(name));
            td2.appendChild(document.createTextNode(discount));
            
            tr.appendChild(td1);
            tr.appendChild(td2);
            tbl.appendChild(tr);

            //---------------------pridanie riadku s celkovou cenou poistky-------------------------------
            tr = document.createElement("tr");
            td1 = document.createElement("td");
            td2 = document.createElement("td");
            
            name = 'cena celkovo';
            td1.appendChild(document.createTextNode(name));
            td2.appendChild(document.createTextNode(total_price));
            
            tr.appendChild(td1);
            tr.appendChild(td2);
            tbl.appendChild(tr);
            

            //-------------------pridnaie info do tabulky info
            tr = document.getElementById("insured_user_name");
            td = document.createElement("td");
            td.appendChild(document.createTextNode(user.name));
            tr.appendChild(td);

            tr = document.getElementById("insurance_number");
            td = document.createElement("td");
            td.appendChild(document.createTextNode(insurance.insurance_number));
            tr.appendChild(td);
            
            tr = document.getElementById("phone");
            td = document.createElement("td");
            td.appendChild(document.createTextNode(user.phone));
            tr.appendChild(td);
            
            tr = document.getElementById("SPZ");
            td = document.createElement("td");
            td.appendChild(document.createTextNode(vehicle.ecv));
            tr.appendChild(td);
        }

        async function approve() {
            //prida info o cene do zmenenej poistky
            changed_insuracne.price = total_price;

            //vlozi zmenenu poistku do databazy
            let options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(changed_insuracne)  //data odosielane v requeste
            };
            const response = await fetch(`/api/changed_insurance/`, options);
            const json = await response.json();
            const changed_insurance_id = json.body;

            //vlozi baliky patriace zmenenej poistky do databazy
            for(item of changed_packages) {
                options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({item, changed_insurance_id}) //data odosielane v requeste
                };
                await fetch('/api/insert_changed_packages/', options);
            }

            localStorage.removeItem('changed_insurance_packages');
            localStorage.removeItem('changed_insurance');
            localStorage.removeItem('selected_insurance_id');

            document.location.href = 'client.html';
        }

        function refuse() {
            localStorage.removeItem('changed_insurance_packages');

            document.location.href = 'select_packages.html';
        }

        create_proposal()

    </script>

<button type="button" onclick="refuse()">zamietnut</button>
<button type="button" onclick="approve()">schvalit</button>

</body>
</html>